# Clump Test: Limit items from same note
# Limit is 3.
# Setup:
# Note A (note-1) has 5 clozes. Priority 100.
# Note B (note-2) has 1 cloze. Priority 50.

session JD1 --clump 3
clock 2025-01-01

topic "Note A" --priority 100
cloze LAST 0 1
cloze LAST 2 3
cloze LAST 4 5
cloze LAST 6 7
cloze LAST 8 9

topic "Note B" --priority 50
cloze LAST 0 1

# 1. Topic A (note-1) - P100. (Score 10050)
inspect-next
expect session.nextItem note-1
grade note-1 3

# 2. A::c1 (note-1::c1) - P100. (Score 10000)
inspect-next
expect session.nextItem note-1::c1
grade note-1::c1 3

# 3. A::c2 (note-1::c2)
inspect-next
expect session.nextItem note-1::c2
grade note-1::c2 3

# Clump history so far: [note-1, note-1::c1, note-1::c2]. Count = 3 from note-1.
# Limit is 3.
# Next pick from note-1 should be blocked.

# 4. Should be Topic B (note-2). P50 -> Score 5050.
# A::c3 is blocked.
inspect-next
expect session.nextItem note-2
grade note-2 3

# 5. Should be B::c1 (note-2::c1). Score 5000.
# A::c3 still blocked?
# History: [..., note-1::c1, note-1::c2, note-2].
# Last 3: note-1, note-1, note-2.
# Not clumped (last one is note-2).
# So A::c3 should be available again?
# But A::c3 Score 10000 > B::c1 Score 5000.
# So A::c3 should come back.
inspect-next
expect session.nextItem note-1::c3
grade note-1::c3 3
