name: Update Documentation

# Requires either ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN secret
on:
    schedule:
        # Run daily at 6:00 AM UTC
        - cron: '0 6 * * *'
    workflow_dispatch: # Manual trigger

permissions:
    contents: write
    pull-requests: write
    id-token: write

jobs:
    update-docs:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '25'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run Claude to update documentation
              id: claude
              uses: anthropics/claude-code-action@beta
              with:
                  anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  direct_prompt: |
                      Analyze this codebase and update any documentation that is out of date.

                      Documentation files to check:
                      - README.md - Project overview and quick start
                      - CLAUDE.md - Claude Code instructions for this project
                      - AGENTS.md - Agent guidelines
                      - docs/ARCHITECTURE.md - Technical design and data model
                      - docs/USER_GUIDE.md - User documentation
                      - docs/MISSING_INCREMENTAL_FEATURES.md - Feature tracking

                      For each documentation file:
                      1. Read the current documentation
                      2. Compare it against the actual implementation in the codebase
                      3. Look for:
                         - Commands or APIs that have changed
                         - New features that aren't documented
                         - Removed features still mentioned in docs
                         - Incorrect file paths or code examples
                         - Outdated configuration options
                      4. Update the documentation to match the current implementation

                      Important:
                      - Only make changes where the documentation is genuinely out of date
                      - Preserve the existing documentation style and structure
                      - Don't add new sections unless necessary to document new features
                      - Be conservative - if you're unsure whether something changed, don't modify it
                  allowed_tools: |
                      Read
                      Edit
                      Glob
                      Grep
                      Bash(pnpm:*)
                      Bash(git status)
                      Bash(git diff)
                  timeout_minutes: 30

            - name: Check for changes
              id: changes
              run: |
                  if [[ -n $(git status --porcelain) ]]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request
              if: steps.changes.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: 'docs: update documentation to match implementation'
                  title: 'docs: automated documentation update'
                  body: |
                      ## Automated Documentation Update

                      This PR was automatically generated by Claude analyzing the codebase and updating documentation to match the current implementation.

                      ### Changes Made
                      Claude identified and updated documentation that was out of sync with the codebase.

                      ### Review Checklist
                      - [ ] Changes accurately reflect the current implementation
                      - [ ] No important information was removed
                      - [ ] Documentation style is consistent

                      ---
                      Generated by [Claude Code Action](https://github.com/anthropics/claude-code-action)
                  branch: docs/automated-update
                  delete-branch: true
                  labels: |
                      documentation
                      automated
